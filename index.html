<!DOCTYPE html><html><head><title>Snake3</title><style>body,html{margin:0;padding:0;overflow:hidden}</style></head><body> <canvas id="canvas" width="1920" height="1080"></canvas> </body></html><script type="module">Array.ofLength=e=>Array.from({length:e});function e(e,t){Object.defineProperties(e.prototype,Object.fromEntries(Object.entries(t).map((([e,t])=>[e,{value:t}]))))}e(Array,{isLastIndex:function(e){return this.length>0&&this.length-1===e},last:function(){if(0===this.length)throw new Error("Last() invoked on empty array ");return this[this.length-1]},implode:function(){return[].concat(...this)},inverted:function(){return this.slice(0).reverse()},pairs:function(){return this.map(((e,t,n)=>[e,n[t+1]])).slice(0,-1)},intervalContains:function(e){if(2===this.length)return this[0]<e&&e<this[1];throw new Error("Array is not an interval, length: "+this.length)},groupBinary:function(e){return this.reduce(((t,n,i,s)=>(t[+e(n,i,s)].push(n),t)),[[],[]])},getRandomElement:function(){if(0===this.length)throw new Error("Array is empty");return this[Math.floor(Math.random()*this.length)]}}),e(Number,{hashCode:function(){let e=this;return e=e+(e<<3)+(e<<5)+(e<<7),e+=e**3,e=e^e>>>13^e>>>26,e&=16383,e=e^e>>>13^e>>>26,e=e<<3^e<<5^e<<7,e=e^e>>>20^e>>>12,e=e^e>>>7^e>>>4,e&=16383,e}});const t=(e,t)=>{const n=e.getContext("2d"),i=t=>(i,s,...a)=>n[t](e.width/2+i,e.height/2-s,...a),s={moveTo:i("moveTo"),lineTo:i("lineTo"),rect:i("rect"),fillText:(t,i,s)=>n.fillText(t,e.width/2+i,e.height/2-s)},a=(e,t,i)=>{if(!e&&!t)throw new Error("No stroke or fill specified");if(e&&!i)throw new Error("Stroke specified, but not line width");e&&(n.strokeStyle=e,n.lineWidth=i,n.stroke()),t&&(n.fillStyle=t,n.fill())};return{clear:()=>{n.fillStyle="white",n.fillRect(0,0,e.width,e.height)},circle:(t,i,{fillStyle:s,strokeStyle:o,lineWidth:r},l)=>{l&&(n.shadowColor=l.shadowColor,n.shadowBlur=l.shadowBlur),n.beginPath(),n.arc(e.width/2+t.x,e.height/2-t.y,i,0,2*Math.PI,!1),a(o,s,r),l&&(n.shadowColor=null,n.shadowBlur=null)},rect:(e,t,i,o,{strokeStyle:r,fillStyle:l,lineWidth:c=1})=>{n.beginPath(),s.rect(e,t,i,o),a(r,l,c)},text:(e,t,i,{fillStyle:a="black",fontSize:o=10,font:r="sans-serif",textAlign:l="center",textBaseline:c="middle"})=>{n.fillStyle=a,n.font=o+"px "+r,n.textAlign=l,n.textBaseline=c,s.fillText(e,t,i)},line:(e,t,{strokeStyle:i,lineWidth:o=1})=>{n.beginPath(),s.moveTo(e.x,e.y),s.lineTo(t.x,t.y),a(i,null,o)},poly:(e,{strokeStyle:t,fillStyle:i,lineWidth:o})=>{n.beginPath(),s.moveTo(...e.last().tuple()),e.forEach((e=>s.lineTo(...e.tuple()))),a(t,i,o)}}};class n{constructor(e,t){this.x=e,this.y=t}length2(){return this.x**2+this.y**2}length(){return Math.sqrt(this.length2())}add(e,t){if(1===arguments.length){if(e instanceof n)return this.add(e.x,e.y);throw new Error(e+" is not a vector")}return new n(this.x+e,this.y+t)}sub(e,t){if(1===arguments.length){if(e instanceof n)return this.sub(e.x,e.y);throw new Error(e+" is not a vector")}return new n(this.x-e,this.y-t)}mul(e){return new n(this.x*e,this.y*e)}div(e){return new n(this.x/e,this.y/e)}toOne(e=!1){const t=this.length();if(0==t){if(e)return this;throw new Error("Vector length is 0")}return this.div(t)}toLength(e,t=!1){const n=this.length();if(0==n){if(t)return this;throw new Error("Vector length is 0")}return this.mul(e/n)}rotate90(){return new n(-this.y,this.x)}inRangeTo(e,t){return this.sub(e).length2()<t**2}isNegligible(e=.1){return-e<this.x&&this.x<e&&-e<this.y&&this.y<e}tuple(){return[this.x,this.y]}angleWith(e){return Math.atan2(this.dotProduct(e),this.crossProduct(e))}crossProduct(e){return this.x*e.x+this.y*e.y}dotProduct(e){return this.x*e.y-this.y*e.x}rotate(e){const t=Math.cos(e),i=Math.sin(e);return new n(t*this.x-i*this.y,i*this.x+t*this.y)}static fromAngle(e){return new n(Math.cos(e),Math.sin(e))}}console.log(new n(1,0).rotate(Math.PI/2),[0,1]),console.log(new n(1,0).rotate90(),[0,1],"rotate90"),console.log(new n(1,0).rotate(Math.PI/4),[1/Math.sqrt(2),1/Math.sqrt(2)]),console.log(new n(0,1).rotate(-Math.PI),[0,-1]);var i=n;class s{pos;radius;inertia;constructor(e,t,n){this.pos=e,this.inertia=t,this.radius=n}collides(e,t=0){return this.pos.inRangeTo(e.pos,this.radius+e.radius+t)}}class a{segments;digestion;state;abilityStates;constructor(e,t,n,i){this.segments=e,this.digestion=t,this.state=n,this.abilityStates=i}getActiveAbility(e,t=[]){const n=Object.entries(this.abilityStates).find((([t,n])=>e<n.activeUntil));return n?[...n,{elapsed:e-n[1].activatedAt}]:n||t}static defaultSegmentRadius=10;static tailRadius=[5,6,7,8,9];static newSegmentLength=3;static tailSegmentGrowth=.025;static onDamagedPushAwayRadius=50;static onDamagedPushAwayStrength=8;static onDamageReceivedSegmentsLoss=3;static onDamageFragileFrames=299;static onDamageShrinkingFrames=a.onDamageReceivedSegmentsLoss*a.defaultSegmentRadius-1;static surviveDamageMinimalLength=a.tailRadius.length+2+a.onDamageReceivedSegmentsLoss;static initialSnakeLength=a.surviveDamageMinimalLength-1;static getTargetRadius(e,t){const n=t.length-e-1;return n<a.tailRadius.length?a.tailRadius[n]:a.defaultSegmentRadius}static Ability={SLOW_ENEMIES:{lengthRequirement:20,duration:300,cooldown:900,activation:"Space",keyHint:"space"},FIRE_BREATH:{lengthRequirement:15,duration:240,cooldown:1140,activation:"ShiftLeft",keyHint:"shift",specificVariables:{windupTime:30,breathRange:100,breathHalfAngle:Math.PI/4,blowStrength:8,isHitWithFireBreath:(e,t)=>{const{specificVariables:n}=a.Ability.FIRE_BREATH,[i,s]=t.segments;return e.inRangeTo(i.pos,n.breathRange)&&Math.abs(i.pos.sub(s.pos).angleWith(e.sub(i.pos)))<n.breathHalfAngle}}}}}class o extends s{generatedAt;constructor(e,t,n,i){super(e,t,n),this.generatedAt=i}}class r extends o{type;chaseTarget;bumpsOccured;damageTaken;dyingAnimation;constructor(e,t,n,i,s,a,o,r){super(e,t,n,r),this.chaseTarget=i,this.bumpsOccured=s,this.damageTaken=a,this.dyingAnimation=o}static enemyBumpStrength=2;static inertiaRetention=.9;static ChaseTarget={HEAD:"head",MID:"mid",TAIL:"tail"};static bumpsSwitchChaseTargetThreshold=3;static switchTargetProbability=.5;static maxHealth=2;static dyingAnimationDuration=60}class l extends o{type;nutrition;constructor(e,t,n,i,s,a){super(e,t,n,i),this.type=s,this.nutrition=a}static inertiaRetention=.9;static Type={FOOD:"food"}}class c{snake;enemies;consumables;maxLength;highScore;constructor(e,t,n,i,s){this.snake=e,this.enemies=t,this.consumables=n,this.maxLength=i,this.highScore=s}static newGameState(){return new c(new a(Array.ofLength(a.initialSnakeLength).reduce((([e,t],n,o,r)=>{const l=a.getTargetRadius(o,r);return[(e+=l)+l,[...t,new s(new i(e,0),new i(0,0),l)]]}),[0,[]])[1],{foodPending:0,foodConsumed:[]},{fragile:-1,shrinking:-1},Object.fromEntries(Object.keys(a.Ability).map((e=>[e,{active:-1,cooldownUntil:-1}])))),[],[],0,0)}}function h(e,t,n){const i=a.Ability[e];return t.abilityStates[e].cooldownUntil<n&&i.lengthRequirement<=t.segments.length}function g(e,t,n=10){for(let s=0;s<n;s++){const n=new i((canvas.width/2-20)*(2*Math.random()-1),(canvas.height/2-20)*(2*Math.random()-1));if(e.every((([e,t])=>t.every((t=>!n.inRangeTo(t.pos,e))))))return[t(n)]}return[]}function d(e,t){for(let[n,i]of e)if(t<n)return i;throw new Error("No fitting phase for "+t)}function u(e,t){return t.reduce(((t,n)=>t.add(e.pos.sub(n.pos).toOne(!0))),new i(0,0)).toOne(!0)}function m(e){return Math.abs(e.pos.x)>=canvas.width/2-10-e.radius||Math.abs(e.pos.y)>=canvas.height/2-10-e.radius}function f(){try{(canvas.webkitRequestFullscreen||canvas.requestFullscreen).apply(canvas,{navigationUI:"hide"})}catch(e){console.log("Error trying to enable fullscreen",e)}}const y={init:{render:e=>{e.rect(-90,40,180,80,{strokeStyle:"black",fillStyle:"white"}),e.text("START",0,0,{fontSize:40,fillStyle:"black"})},clickHandlers:[[[[-90,90],[-40,40]],()=>(f(),["game",c.newGameState()])]]},game:{physicalTick:function(e,t,n){let o,h=e.snake.getActiveAbility(n,null);o=h&&"FIRE_BREATH"===h[0]?h[2].elapsed<a.Ability.FIRE_BREATH.specificVariables.windupTime?new i(6,0):new i(4,0):t.up?new i(4,0):t.down?new i(1,0):new i(2,0),t.left?o.y=1:t.right&&(o.y=-1);const[f,y]=e.consumables.groupBinary((t=>e.snake.segments[0].collides(t))),p=y.reduce(((e,t)=>e+t.nutrition),0),w=e.enemies.some((t=>!t.dyingAnimation&&e.snake.segments.some((e=>e.collides(t)))))||-1===e.snake.state.shrinking&&e.snake.segments.slice(2).some((t=>t.collides(e.snake.segments[0])))||m(e.snake.segments[0]);if(w)console.log("Snake took damage!");else if(!h){const i=Object.entries(a.Ability).find((([i,s])=>t[s.activation]&&e.snake.segments.length>=s.lengthRequirement&&e.snake.abilityStates[i].cooldownUntil<n));if(i){const[e,t]=i;h=[e,{activatedAt:n,activeUntil:n+t.duration,cooldownUntil:n+t.cooldown},{elapsed:0}],console.log("Ability activated:",e)}}Object.entries(e.snake.abilityStates).forEach((([e,t])=>t.activeUntil===n&&console.log("Ability wears off:",e)));const S=e.snake.digestion.foodPending>0&&e.snake.digestion.foodConsumed.every((t=>t>4*e.snake.segments[0].radius)),k=e.snake.segments.slice(1,-1).reduce(((e,t)=>e+2*t.radius),0),[b,A]=e.snake.digestion.foodConsumed.groupBinary((e=>e>k)),v=A.length>0?[e.snake.segments.slice(-2).reduce(((e,t)=>new s(t.pos.add(t.pos.sub(e.pos).toLength(a.newSegmentLength)),new i(0,0),a.newSegmentLength)))]:[];if(w&&e.snake.state.fragile>=0||w&&e.snake.segments.length<a.surviveDamageMinimalLength){const t=+localStorage.getItem("best")||0;return t<e.highScore&&localStorage.setItem("best",e.highScore),{gameOver:!0,maxLength:e.maxLength,highScore:e.highScore,prevBest:t}}const E=w?{fragile:a.onDamageFragileFrames,shrinking:a.onDamageShrinkingFrames}:{fragile:Math.max(-1,e.snake.state.fragile-1),shrinking:Math.max(-1,e.snake.state.shrinking-1)},R=w?{foodPending:0,foodConsumed:[]}:{foodPending:e.snake.digestion.foodPending-+S+p,foodConsumed:b.map((e=>e+o.x)).concat(S?[0]:[])};let T;if(E.shrinking>=0){const t=1,n=E.shrinking%e.snake.segments[t].radius;T=(0===n?e.snake.segments.filter(((e,n)=>n!==t)):e.snake.segments).map(((e,i,a)=>{const o=a[i+1],r=i==t&&n>0?n:e.radius;return i<3?new s(o.pos.add(e.pos.sub(o.pos).toLength(2*r-1)),e.inertia,e.radius):e}))}else T=e.snake.segments.map(((e,t,n)=>{if(0==t)return new s(e.pos.add(e.pos.sub(n[t+1].pos).toLength(o.x)).add(e.pos.sub(n[t+1].pos).rotate90().toLength(o.y)),e.inertia,e.radius);{const i=n[t-1].radius+e.radius-1,o=a.getTargetRadius(t,n),r=e.radius===o?o:Math.min(o,e.radius+a.tailSegmentGrowth);return new s(n[t-1].pos.add(e.pos.sub(n[t-1].pos).toLength(i)),e.inertia,r)}})).concat(v);const[x,L]=e.enemies.groupBinary((e=>!e.dyingAnimation||n<=e.dyingAnimation));return new c(new a(T,R,E,h?{...e.snake.abilityStates,...Object.fromEntries([h])}:e.snake.abilityStates),function(e,t,n,i,s){return e.filter((e=>!m(e))).map(((o,l)=>{let c,h=!1,g=o.damageTaken,d=o.dyingAnimation;if("FIRE_BREATH"===s[0]&&s[2].elapsed>a.Ability.FIRE_BREATH.specificVariables.windupTime){const{specificVariables:e}=a.Ability.FIRE_BREATH;e.isHitWithFireBreath(o.pos,t.snake)&&(g+=10,d||(d=i+r.dyingAnimationDuration),c=o.pos.sub(t.snake.segments[0].pos).toLength(e.blowStrength))}if(n){const e=t.snake.segments.filter((e=>e.collides(o,a.onDamagedPushAwayRadius)));e.length>0&&(c=u(o,e).toLength(a.onDamagedPushAwayStrength,!0),e.some((e=>e.collides(o)))&&(d||++g>=r.maxHealth&&(d=i+r.dyingAnimationDuration)))}if(!c){const t=e.filter((e=>!e.dyingAnimation&&e!==o&&o.collides(e)));t.length>0&&(h=!0,c=u(o,t).toLength(r.enemyBumpStrength,!0))}c||(c=o.inertia);const m=o.bumpsOccured+(h?1:0),f=m>=r.bumpsSwitchChaseTargetThreshold&&Math.random()<r.switchTargetProbability?Object.values(r.ChaseTarget).getRandomElement():o.chaseTarget,y=m%r.bumpsSwitchChaseTargetThreshold,p="SLOW_ENEMIES"===s[0]?.5:1;if(c.isNegligible()&&!o.dyingAnimation){const e={head:t.snake.segments[0].pos,mid:t.snake.segments[Math.floor(t.snake.segments.length/2)].pos,tail:t.snake.segments.last().pos};return new r(o.pos.add(e[o.chaseTarget].sub(o.pos).toLength(p)),c,o.radius,f,y,g,d,o.generatedAt)}return new r(o.pos.add(c),c.mul(r.inertiaRetention),o.radius,f,y,g,d,o.generatedAt)}))}(L,e,w,n,h||[]).concat(function(e,t){const n=d([[180,0],[600,1],[1200,2],[1800,3],[7200,4],[10800,5],[14400,6],[18e3,7],[21600,8],[25200,9],[28800,10],[Number.MAX_SAFE_INTEGER,10]],t);return e.enemies.length>=n||e.enemies.some((e=>t-e.generatedAt<60))?[]:g(function(e){return[[300,e.snake.segments],[300,e.enemies],[100,e.consumables]]}(e),(e=>new r(e,new i(0,0),10,r.ChaseTarget.HEAD,0,0,0,t)))}(e,n)),function(e,t,n,s,o){const r=t.snake.segments.slice(1).concat(t.enemies.filter((e=>!e.dyingAnimation)));return e.filter((e=>!m(e))).map((e=>{let s;if("FIRE_BREATH"===o[0]&&o[2].elapsed>a.Ability.FIRE_BREATH.specificVariables.windupTime){const{specificVariables:n}=a.Ability.FIRE_BREATH;n.isHitWithFireBreath(e.pos,t.snake)&&(s=e.pos.sub(t.snake.segments[0].pos).toLength(n.blowStrength))}if(!s&&n){const n=t.snake.segments.filter((t=>t.collides(e,a.onDamagedPushAwayRadius)));n.length>0&&(s=u(e,n).toLength(a.onDamagedPushAwayStrength,!0))}if(!s){const t=r.filter((t=>t.collides(e)));t.length>0&&(s=t.reduce(((t,n)=>t.add(e.pos.sub(n.pos).toOne(!0))),new i(0,0)).div(t.length).toOne(!0))}return s||(s=e.inertia),new l(e.pos.add(s),s.mul(l.inertiaRetention),e.radius,e.generatedAt,e.type,e.nutrition)}))}(f,e,w,0,h||[]).concat(function(e,t,n){const s=d([[60,0],[1200,1],[3600,5],[Number.MAX_SAFE_INTEGER,10]],n);return t.length>=s||t.some((e=>n-e.generatedAt<60))?[]:g(function(e,t){return[[300,e.snake.segments],[100,e.enemies],[50,t]]}(e,t),(e=>new l(e,new i(0,0),n<1200?7:n<3600?5:3,n,l.Type.FOOD,1)))}(e,f,n)).concat(x.map((e=>function(e,t){return new l(e.pos,new i(0,0),5,t,l.Type.Food,3)}(e,n)))),Math.max(e.maxLength,e.snake.segments.length),e.highScore+p*(e.maxLength>e.snake.segments.length?50:100))},render:function(e,t,n,i){i&&e.clear(),e.clear(),e.rect(-canvas.width/2+10,canvas.height/2-10,canvas.width-20,canvas.height-20,{strokeStyle:"black"});let s=t.snake.getActiveAbility(n);if("FIRE_BREATH"===s[0]&&s[2].elapsed>a.Ability.FIRE_BREATH.specificVariables.windupTime){const{specificVariables:g}=a.Ability.FIRE_BREATH,[d,u]=t.snake.segments;for(let m=s[1].activatedAt;m<n;m++){const f=n-m;if(f>10&&f<g.breathRange){const y=m.hashCode(),p=y.hashCode(),w=p.hashCode();function o(e,t){return e>>>2*t&3}for(let S=0;S<7;S++){const k=o(y,S),b=o(p,S),A=o(w,S),v=-g.breathHalfAngle+2*g.breathHalfAngle*(S/7+A/7/4);if(k>0){const E=[null,"yellow","orange","red"][k];e.circle(t.snake.segments[0].pos.add(t.snake.segments[0].pos.sub(t.snake.segments[1].pos).rotate(v).toLength(f)),b,{fillStyle:E})}}}}}const l=t.snake.segments.reduce(((e,t,n)=>e.length?[...e,e.last()+2*t.radius]:[t.radius]),[]).pairs(),c=t.snake.segments.map(((e,n,i)=>{let s,a,o;if(n+1<i.length){s=i[n+1],a=e.pos.add(s.pos).div(2);const r=n>0&&t.snake.digestion.foodConsumed.some((e=>l[n-1].intervalContains(e)));o=(e.radius+s.radius)/2+(r?2:0)}else s=e,e=i[n-1],a=s.pos,o=s.radius;const r=e.pos.sub(s.pos).rotate90().toLength(o,!0);return[a.add(r),a.sub(r)]}));t.snake.segments.forEach(((i,a,o)=>{if(0===a){if("SLOW_ENEMIES"===s[0])for(let t=0;t<4;t++)e.circle(i.pos,10,{fillStyle:"rgba(0,0,0,1)"},{shadowColor:"cyan",shadowBlur:50});const a=-1===t.snake.state.fragile?"lightgreen":"orange",r=c[0][1].sub(c[0][0]).toOne(),l=i.pos,g=l.sub(o[1].pos).toOne(),d=i.radius,u=1,m=[l.add(r.toLength(d+u)),l.add(r.toLength(-d-u))];e.poly([...c[0],m[0],l.add(r.toLength(d/2)).add(g.mul(1.5*d)),l.add(r.toLength(-d/2)).add(g.mul(1.5*d)),m[1]],{strokeStyle:a,fillStyle:a,lineWidth:1}),e.circle(l.add(r.toLength(d/2)).add(g.mul(2)),1,{fillStyle:"black",strokeStyle:""}),e.circle(l.add(r.toLength(-d/2)).add(g.mul(2)),1,{fillStyle:"black",strokeStyle:""}),h("SLOW_ENEMIES",t.snake,n)&&e.circle(l.add(g.mul(-4)),2,{fillStyle:"cyan",strokeStyle:"blue",lineWidth:1}),h("FIRE_BREATH",t.snake,n)&&(e.line(c[0][1],m[0],{strokeStyle:"orange"}),e.line(c[0][0],m[1],{strokeStyle:"orange"}))}else{const n=t.snake.digestion.foodConsumed.some((e=>l[a-1].intervalContains(e)))?"rgb(0,100,0)":"green";a+1===o.length&&e.circle(i.pos,i.radius,{fillStyle:n,strokeStyle:n,lineWidth:1}),e.poly(c[a-1].concat(c[a].inverted()),{fillStyle:n,strokeStyle:n,lineWidth:1}),e.line(i.pos,c[a-1][0],{strokeStyle:"yellow"}),e.line(i.pos,c[a-1][1],{strokeStyle:"yellow"}),a+1<o.length&&(e.line(i.pos,c[a][0],{strokeStyle:"yellow"}),e.line(i.pos,c[a][1],{strokeStyle:"yellow"}))}}),0),t.enemies.forEach((t=>{const i=t.damageTaken>0?64:0,[a,o]=function(e){if(e.dyingAnimation){const t=(e.dyingAnimation-n)/r.dyingAnimationDuration;return t<=0?[1/60,e.radius+10]:[t,e.radius+10*(1-t)]}return[1,e.radius]}(t),l="SLOW_ENEMIES"===s[0]?{shadowColor:"cyan",shadowBlur:15}:null;e.circle(t.pos,o,{fillStyle:`rgba(255,${i},${i},${a})`},l)})),t.consumables.forEach((t=>{1===t.nutrition?e.circle(t.pos,t.radius,{fillStyle:"purple"}):e.circle(t.pos,t.radius,{fillStyle:"gold",strokeStyle:"orange",lineWidth:1})})),e.text("Score: "+t.highScore,canvas.width/2-20,canvas.height/2-20,{fillStyle:"black",fontSize:40,textAlign:"end",textBaseline:"top"}),n>3600&&Object.entries(a.Ability).some((([i,a])=>{if(-1===t.snake.abilityStates[i].cooldownUntil&&h(i,t.snake,n)&&!s[0])return e.text("press "+a.keyHint,t.snake.segments[0].pos.x+20,t.snake.segments[0].pos.y+20,{fillStyle:"black",fontSize:20,textAlign:"left"}),!0}))},onBlur:()=>"gamePaused"},gamePaused:{render:(e,t,n,i)=>{i&&(e.clear(),console.log(t)),e.rect(-160,30,320,60,{strokeStyle:"black",fillStyle:"white"}),e.text("click to unpause",0,0,{fontSize:40,fillStyle:"black"})},clickHandlers:[[[[-160,160],[-30,30]],()=>(f(),"game")]]},gameOver:{render:(e,t,n,i)=>{i&&e.clear(),e.rect(-160,100,320,200,{strokeStyle:"black",fillStyle:"white"}),e.text("GAME OVER",0,40,{fontSize:40,fillStyle:"black",textBaseline:"bottom"});const{prevBest:s,highScore:a,maxLength:o}=t;(s<a?["New best! "+a,"Previous best: "+s,"Max length achieved: "+o]:["Highscore: "+a,"Your best: "+s,"Max length achieved: "+o]).forEach(((t,n)=>{e.text(t,0,30-20*n,{fontSize:20,fillStyle:"black",textBaseline:"top"})})),e.rect(-100,-35,200,50,{strokeStyle:"black",fillStyle:"white"}),e.text("play again",0,-60,{fontSize:40,fillStyle:"black"})},clickHandlers:[[[[-100,100],[-85,-35]],()=>(f(),["game",c.newGameState()])]]},credits:()=>{}};let p={KeyW:!1,KeyA:!1,KeyS:!1,KeyD:!1,Space:!1,ArrowUp:!1,ArrowLeft:!1,ArrowDown:!1,ArrowRight:!1,Digit1:!1,ShiftLeft:!1};function w(e){return t=>{p.hasOwnProperty(t.code)&&(p[t.code]=e)}}!function(){let e="init",n=null,i=null;function s(t){y[t]?console.log(e+" -> "+t):console.log("activeScreen"+e+" tried to transition into non existing activeScreen "+t),e=t}const a=t(canvas,(canvas.width,canvas.height));window.addEventListener("blur",(()=>{y[e].onBlur&&s(y[e].onBlur())})),canvas.addEventListener("click",(t=>{const a=t.x-canvas.width/2,o=canvas.height/2-t.y;(y[e].clickHandlers||[]).some((([e,t])=>{const r=(e,[t,n])=>t<=e&&e<=n;if(r(a,e[0])&&r(o,e[1])){const e=t(a,o);if("string"==typeof e)s(e);else{const[t,a]=e;s(t),n=a,i=0}return!0}}))})),document.addEventListener("keydown",w(!0)),document.addEventListener("keyup",w(!1)),setInterval((()=>{y[e].physicalTick&&(n=y[e].physicalTick(n,{up:p.KeyW||p.ArrowUp,left:p.KeyA||p.ArrowLeft,down:p.KeyS||p.ArrowDown,right:p.KeyD||p.ArrowRight,Space:p.Space,ShiftLeft:p.ShiftLeft},++i)),n&&n.gameOver&&"gameOver"!==e?s("gameOver"):function(e,t,n,i,s){window.innerWidth!==canvas.width||window.innerHeight!==canvas.height?(console.log("resize canvas",canvas.width,canvas.height,"to",window.innerWidth,window.innerHeight,"current activeScreen:",s),canvas.height=window.innerHeight,canvas.width=window.innerWidth,setTimeout((s=>t(e,n,i,!0)),0)):t(e,n,i,!1)}(a,((...t)=>{try{y[e].render(...t)}catch(t){console.log("Failed to render for activeScreen: "+e,t)}}),n,i,e)}),1e3/60)}();</script>