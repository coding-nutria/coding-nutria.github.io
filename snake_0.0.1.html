<!DOCTYPE html><html><head><title>Snake3</title><style>body,html{margin:0;padding:0;overflow:hidden}</style></head><body> <canvas id="canvas" width="1920" height="1080"></canvas> </body></html><script type="module">Array.ofLength=e=>Array.from({length:e});const e={isLastIndex:function(e){return this.length>0&&this.length-1===e},negIndex:function(e){if(e>=0&&e<this.length)return this.length-e;throw new Error("Index out of bounds "+e+" max length "+this.length)},last:function(){if(0===this.length)throw new Error("Last() invoked on empty array ");return this[this.length-1]},getByNegIndex:function(e){if(-e>=this.length||e>=0)throw new Error("Neg index out of bounds "+e+" length "+this.length);return this[this.length+e-1]},implode:function(){return[].concat(...this)},inverted:function(){return this.slice(0).reverse()}};Object.defineProperties(Array.prototype,Object.fromEntries(Object.entries(e).map((([e,t])=>[e,{value:t}]))));class t{constructor(e,t){this.x=e,this.y=t}length2(){return this.x**2+this.y**2}length(){return Math.sqrt(this.length2())}add(e,n){return 1===arguments.length?this.add(e.x,e.y):new t(this.x+e,this.y+n)}sub(e,n){return 1===arguments.length?this.sub(e.x,e.y):new t(this.x-e,this.y-n)}mul(e){return new t(this.x*e,this.y*e)}div(e){return new t(this.x/e,this.y/e)}one(e=!1){const t=this.length();if(0==t){if(e)return this;throw new Error("Vector length is 0")}return this.div(t)}toLength(e,t=!1){const n=this.length();if(0==n){if(t)return this;throw new Error("Vector length is 0")}return this.mul(e/n)}rotate90(){return new t(this.y,-this.x)}inRangeTo(e,t){return this.sub(e).length2()<t**2}isNegligible(e=.1){return-e<this.x&&this.x<e&&-e<this.y&&this.y<e}tuple(){return[this.x,this.y]}static fromAngle(e){return new t(Math.cos(e),Math.sin(e))}}var n=t;const i=(e,t)=>{const n=e.getContext("2d"),i=e=>(i,o,...s)=>n[e](t.x+i,t.y-o,...s),o={moveTo:i("moveTo"),lineTo:i("lineTo")};return{clear:()=>{n.clearRect(0,0,e.width,e.height)},circle:(e,i,o,s)=>{const a=t.x+e.x,r=t.y-e.y;n.beginPath(),n.arc(a,r,i,0,2*Math.PI,!1),n.fillStyle=o,n.fill(),s&&(n.lineWidth=1,n.strokeStyle=s,n.stroke())},rect:(e,t,i,o,s,a)=>{n.beginPath(),n.rect(e,t,i,o),n.lineWidth=3,s&&(n.strokeStyle=s,n.stroke()),a&&(n.fillStyle=a,n.fill())},text:(e,t,i,{fillStyle:o,font:s,textAlign:a,textBaseline:r})=>{n.fillStyle=o,n.font=s,n.textAlign=a,n.textBaseline=r,n.fillText(e,t,i)},line:(e,i,o)=>{n.beginPath(),n.moveTo(t.x+e.x,t.y-e.y),n.lineTo(t.x+i.x,t.y-i.y),n.strokeStyle=o,n.stroke()},poly:(e,t,i)=>{n.beginPath(),o.moveTo(...e.last().tuple()),e.forEach((e=>o.lineTo(...e.tuple()))),i&&(n.fillStyle=i,n.fill()),t&&(n.lineWidth=1,n.strokeStyle=t,n.stroke())}}};console.log(new n(1,1).length2());const o=[5,6,7,8,9],s=[4,5,6,7,8,9],a=[100,150];let r={snake:Array.ofLength(8).map(((e,t)=>new n(16*t,0))),food:[],digestion:{foodPending:0,foodBeingProcessed:[]},takingDamage:{vulnerableFrames:0,shrinking:0},enemies:[],maxSnakeLength:0,highScore:0},l={KeyW:!1,KeyA:!1,KeyS:!1,KeyD:!1,Space:!1};function d(e){const t=e.foodBeingProcessed.find((e=>e.digested));return t?s.map((e=>e+Math.min(1,(t.digestionValue-t.digestedAtValue)/10))):o}function h(e,t,n){return d(n)[t.negIndex(e)]||10}new n(0,0),new n(0,0);function g({snake:e,food:t,digestion:o,takingDamage:s,enemies:r,maxSnakeLength:g,highScore:c}){let f=0;t=t.filter((t=>!e[0].inRangeTo(t.position,h(0,e,o))||(f++,!1))),c+=f*(e.length<g?50:100);const m=[...e.slice(1),...r.map((e=>e.position))];t=t.map((e=>{const t=m.filter((t=>t.inRangeTo(e.position,13)));if(t.length>0){const i=t.reduce(((t,n)=>t.add(e.position.sub(n).one(!0))),new n(0,0)).one(!0);return{...e,impulse:i}}return e})),o={...o,foodPending:o.foodPending+f},s={...s,vulnerable:Math.max(0,s.vulnerable-60*f)},o.foodPending>0&&o.foodBeingProcessed.every((e=>e.digestionValue>40))&&(o={...o,foodBeingProcessed:[{digestionValue:0,digested:!1},...o.foodBeingProcessed],foodPending:o.foodPending-1});const p=r.map((t=>t.dead?[]:e.filter((e=>t.position.inRangeTo(e,t.radius+10))))),y=p.some((e=>e.length>0));if(y||e.slice(3).some((t=>t.inRangeTo(e[0],20)))||function(){const t=e[0].x+canvas.width/2,n=e[0].y+canvas.height/2;return t<20||canvas.width-10-10<t||n<20||canvas.height-10-10<n}()){if(s.vulnerable>0||e.length<7)return function({highScore:e}){clearInterval(u),console.log("Game over");const t=i(canvas,new n(canvas.width/2,canvas.height/2)),o=200,s=100;t.rect(canvas.width/2-o/2,canvas.height/2-s/2,o,s,"black","white");const a=+localStorage.getItem("best")||0;e>a?(localStorage.setItem("best",e),t.text("New best! "+e,canvas.width/2,canvas.height/2-15,{fillStyle:"black",font:"20px sans-serif",textAlign:"center",textBaseline:"middle"}),t.text("Previous best: "+a,canvas.width/2,canvas.height/2+15,{fillStyle:"black",font:"20px sans-serif",textAlign:"center",textBaseline:"middle"})):(t.text("Highscore: "+e,canvas.width/2,canvas.height/2-15,{fillStyle:"black",font:"20px sans-serif",textAlign:"center",textBaseline:"middle"}),t.text("Your best: "+a,canvas.width/2,canvas.height/2+15,{fillStyle:"black",font:"20px sans-serif",textAlign:"center",textBaseline:"middle"}))}({highScore:c}),{gameOver:!0};if(s={...s,vulnerable:300,shrinking:29},o={...o,foodBeingProcessed:[]},y){p.implode();const t=e;r=r.map(((e,i)=>{const o=t.filter((t=>e.position.inRangeTo(t,e.radius+10+100)));if(o.length>0){const t=o.reduce(((t,n)=>t.add(e.position.sub(n).one(!0))),new n(0,0)).toLength(7,!0),s=p[i].length>0;return{...e,damaged:s,dead:e.damaged&&s,dying:e.dead?e.dying:30,impulse:t}}return e}))}}else s={...s,vulnerable:Math.max(0,s.vulnerable-1),shrinking:Math.max(0,s.shrinking-1)};if(s.shrinking>0){const t=s.shrinking%10||10;e=1===t?e.slice(1):e.map(((e,n,i)=>0===n?i[1].add(e.sub(i[1]).toLength(t)):e))}else e=e.map(((e,t,i)=>{if(0==t){let s;return s=l.KeyW?new n(4,0):l.KeyS?new n(1,0):new n(2,0),l.KeyA?s.y=-1:l.KeyD&&(s.y=1),o={...o,foodBeingProcessed:o.foodBeingProcessed.map((e=>({...e,digestionValue:e.digestionValue+s.x})))},e.add(e.sub(i[t+1]).toLength(s.x)).add(e.sub(i[t+1]).rotate90().toLength(s.y))}{const n=2*h(t,i,o)-4;return i[t-1].add(e.sub(i[t-1]).toLength(n))}}));const x=function(e,t){const n=d(e);return 2*(t.length-n.length)*10+n.reduce(((e,t)=>e+2*t),0)-10}(o,e);function w(i,[o,s],a,l,d){for(let h=0;h<i;h++){const i=Math.random()*Math.PI*2,h=o+Math.random()*(s-o),g=e[0].add(n.fromAngle(i).mul(h));if(!e.some((e=>e.inRangeTo(g,a)))&&!t.some((e=>e.position.inRangeTo(g,l)))&&!r.some((e=>e.position.inRangeTo(g,d))))return g}return null}if(o.foodBeingProcessed.length>0&&o.foodBeingProcessed.last().digestionValue>x&&(o.foodBeingProcessed.last().digested?o.foodBeingProcessed.last().digestionValue>x+2*d(o).last()&&(o={...o,foodBeingProcessed:o.foodBeingProcessed.slice(0,-1)}):(e=e.concat(e.last().add(e.last().sub(e.getByNegIndex(-2)).toLength(5))),o={...o,foodBeingProcessed:[...o.foodBeingProcessed.slice(0,-1),{...o.foodBeingProcessed.last(),digested:!0,digestedAtValue:o.foodBeingProcessed.last().digestionValue}]})),t=t.map((e=>({...e,position:e.position.add(e.impulse),impulse:e.impulse.mul(.9)}))),(r=(r=r.map((t=>{if(t.impulse.isNegligible()&&!t.dead){const n={head:e[0],mid:e[Math.floor(e.length/2)],tail:e.last()};return{...t,position:t.position.add(n[t.chasing].sub(t.position).one())}}return{...t,position:t.position.add(t.impulse),impulse:t.impulse.mul(.9),dying:Math.max(0,t.dying-1)}})).filter((e=>!e.dead||e.dying>0))).map((e=>[e,r.filter((t=>t!==e&&e.position.inRangeTo(t.position,e.radius+t.radius)))])).map((([e,t])=>{if(t.length>0){const i=t.reduce(((t,n)=>t.add(e.position.sub(n.position).one(!0))),new n(0,0)).toLength(2,!0);return{...e,impulse:i,bumps:e.bumps+1,chasing:e.bumps%3==0&&Math.random()<.5?["head","mid","tail"][Math.floor(3*Math.random())]:e.chasing}}return e}))).length<3){const e=w(10,[300,400],100,50,300);e&&(r=[...r,{position:e,impulse:new n(0,0),radius:10,bumps:0,chasing:"head"}])}if(t.length<10){const e=w(10,a,30,30,30);e&&(t=t.concat({position:e,impulse:new n(0,0)}))}return{snake:e,food:t,digestion:o,takingDamage:s,enemies:r,maxSnakeLength:Math.max(g,e.length),highScore:c}}function c({snake:e,food:t,digestion:o,takingDamage:s,enemies:a,highScore:r}){const l=i(canvas,new n(canvas.width/2,canvas.height/2));l.clear(),l.rect(10,10,canvas.width-20,canvas.height-20,"black");const g=[];function c(...e){g.push(e)}const u=e.map(((e,t,n)=>{let i,s,a;t+1<n.length?(i=n[t+1],s=e.add(i).div(2),a=(h(t+1,n,o)+h(t,n,o))/2-(0===t?2:0)):(i=e,e=n[t-1],s=i,a=h(t,n,o));const r=e.sub(i).rotate90().toLength(a,!0);return[s.add(r),s.sub(r)]}));e.reduce(((t,n,i,a)=>{const r=h(i,a,o);if(0===i){const t=s.vulnerable>0?"orange":"lightgreen",n=u[0][1].sub(u[0][0]).one(),i=e[0].sub(e[1]).one();return l.poly([...u[0],e[0].add(n.toLength(10)),e[0].add(n.toLength(5)).add(i.mul(15)),e[0].add(n.toLength(-5)).add(i.mul(15)),e[0].add(n.toLength(-10))],t,t),l.circle(e[0].add(n.toLength(5)).add(i.mul(2)),1,"black"),l.circle(e[0].add(n.toLength(-5)).add(i.mul(2)),1,"black"),r}if(o.foodBeingProcessed.some((e=>0<e.digestionValue-t&&e.digestionValue-t<2*r))){const t=e.negIndex(i)<d(o).length?0:1;i+1===a.length&&c(n,r+t,"rgb(0, 100, 0)"),l.poly(u[i-1].concat(u[i].inverted()),"rgb(0, 100, 0)","rgb(0, 100, 0)")}else i+1===a.length&&c(n,r,"green"),l.poly(u[i-1].concat(u[i].inverted()),"green","green");return l.line(n,u[i-1][0],"yellow"),l.line(n,u[i-1][1],"yellow"),l.line(n,u[i][0],"yellow"),l.line(n,u[i][1],"yellow"),t+2*r}),0),g.reverse().forEach((e=>l.circle(...e))),t.forEach((e=>l.circle(e.position,3,"purple"))),a.forEach((e=>{const t=e.damaged?64:0,n=e.dead?e.dying/30:1,i=e.radius+(e.dead?10-e.dying/30*10:0);l.circle(e.position,i,`rgba(255,${t},${t},${n})`)})),l.text("Score: "+r,canvas.width-20,20,{fillStyle:"black",font:"40px sans-serif",textAlign:"end",textBaseline:"top"})}const u=setInterval((e=>{var t;(t=r=g(r)).gameOver||(window.innerWidth!==canvas.width||window.innerHeight!==canvas.height?(console.log("resize canvas",canvas.width,canvas.height,"to",window.innerWidth,window.innerHeight),canvas.height=window.innerHeight,canvas.width=window.innerWidth,setTimeout((e=>c(t)),0)):c(t))}),1e3/60);function f(e){return t=>{l.hasOwnProperty(t.code)&&(l[t.code]=e)}}document.addEventListener("keydown",f(!0)),document.addEventListener("keyup",f(!1));</script>